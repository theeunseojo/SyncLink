<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ì„ ì‹œê°„ ê²°ê³¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

    <style>
        /* ìº˜ë¦°ë” í¬ê¸° ì¡°ì ˆ */
        #calendar {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 10px;
            border-radius: 10px;
        }
        /* ë¹ˆ ì‹œê°„(ê°€ëŠ¥í•œ ì‹œê°„) í•˜ì´ë¼ì´íŒ… ìƒ‰ìƒ */
        .free-time-highlight {
            background-color: #d4edda !important; /* ì—°í•œ ì´ˆë¡ìƒ‰ */
            border: none !important;
            opacity: 0.7;
        }
        .fc-event-title {
            color: #155724;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>âœ¨ ìš°ë¦¬ ì¡° ê°€ëŠ¥í•œ ì‹œê°„</h4>
        <button class="btn btn-outline-primary btn-sm" onclick="copyLink()">ğŸ”— ë§í¬ ë³µì‚¬</button>
    </div>

    <div id='calendar' class="shadow-sm"></div>

    <div class="text-center mt-4">
        <p class="text-muted small">ë‚´ ì¼ì •ë„ í¬í•¨í•´ì„œ ë‹¤ì‹œ ê³„ì‚°í•˜ë ¤ë©´?</p>
        <a id="loginBtn" href="#" class="btn btn-dark btn-sm">
            ğŸ“… êµ¬ê¸€ ë¡œê·¸ì¸í•˜ê³  ì°¸ì—¬í•˜ê¸°
        </a>
    </div>
</div>

<script>

    let calendar; // ì „ì—­ ë³€ìˆ˜

    document.addEventListener('DOMContentLoaded', async function() {
        const calendarEl = document.getElementById('calendar');
        const params = new URLSearchParams(window.location.search);
        const uuid = params.get('uuid');

        if (!uuid) {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
            return;
        }

        // ë¡œê·¸ì¸ ë²„íŠ¼ ë§í¬ ì„¤ì • (/login/google?uuid=...)
        document.getElementById('loginBtn').href = `/login/google?uuid=${uuid}`;


        // 1. ìº˜ë¦°ë” ê¸°ë³¸ ì„¤ì • (FullCalendar v6)
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek', // ì£¼ê°„ ë·° (ì‹œê°„ê¹Œì§€ ë³´ì„)
            locale: 'ko', // í•œêµ­ì–´
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'timeGridWeek,dayGridMonth'
            },
            allDaySlot: false, // ì¢…ì¼ ì¼ì • ì¹¸ ìˆ¨ê¸°ê¸° (í•„ìš”í•˜ë©´ true)
            slotMinTime: '08:00:00', // ìº˜ë¦°ë” ì‹œì‘ ì‹œê°„ (ì˜¤ì „ 8ì‹œ)
            slotMaxTime: '22:00:00', // ìº˜ë¦°ë” ì¢…ë£Œ ì‹œê°„ (ì˜¤í›„ 10ì‹œ)
            height: 'auto',

            // â­ í´ë¦­ ì´ë²¤íŠ¸ (ê¾¹ ëˆ„ë¥´ê¸°/í´ë¦­)
            dateClick: function(info) {
                // ì—¬ê¸°ì„œ "ì‹œê°„ ì„¤ì •" íŒì—…ì„ ë„ìš°ë©´ ë©ë‹ˆë‹¤!
                alert('ì„ íƒí•œ ì‹œê°„: ' + info.dateStr);
            },
            events: [] // ë°ì´í„°ëŠ” ì•„ë˜ì—ì„œ ì±„ì›€
        });

        calendar.render(); // ì¼ë‹¨ ë¹ˆ ìº˜ë¦°ë” ê·¸ë¦¬ê¸°

        // 2. ë°±ì—”ë“œì—ì„œ ë¹ˆ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
        try {
            const response = await fetch(`/api/schedule/${uuid}/events`);
            if (response.ok) {
                const timeSlots = await response.json();

                // 3. ë°ì´í„°ë¥¼ FullCalendar í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const events = timeSlots.map(slot => ({
                    title: 'ê°€ëŠ¥!',
                    start: slot.start,
                    end: slot.end,
                    display: 'background', // â­ ë°°ê²½ìƒ‰ìœ¼ë¡œ ì¹ í•˜ê¸° (ì¤‘ìš”)
                    className: 'free-time-highlight' // CSS í´ë˜ìŠ¤ ì ìš©
                }));

                // ìº˜ë¦°ë”ì— ì´ë²¤íŠ¸ ì¶”ê°€
                calendar.addEventSource(events);
            }
        } catch (error) {
            console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨", error);
        }
    });

    function copyLink() {
        navigator.clipboard.writeText(window.location.href);
        alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ì„¸ìš”.");
    }
</script>

</body>
</html>