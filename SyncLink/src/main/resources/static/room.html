<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ì„ ì‹œê°„ ì¡°ìœ¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        #calendar {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 15px;
            border-radius: 12px;
            min-height: 600px;
        }

        /* 1. ê²°ê³¼: ê°€ëŠ¥í•œ ì‹œê°„ (ì´ˆë¡ìƒ‰) */
        .free-time-highlight {
            background-color: #28a745 !important;
            opacity: 0.6;
            border: none;
        }

        /* 2. í¸ì§‘: ë¬´ì‹œëœ ë‚´ ì¼ì • (íšŒìƒ‰ + ì·¨ì†Œì„ ) */
        .ignored-event {
            background-color: #d6d8db !important;
            border-color: #c6c8cb !important;
            text-decoration: line-through;
            opacity: 0.7;
            color: #6c757d !important;
        }

        /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .nav-pills .nav-link.active {
            background-color: #343a40;
        }
        .nav-pills .nav-link {
            color: #343a40;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-4 mb-5">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 id="roomTitle">ğŸ“… ëª¨ì„ ì‹œê°„ ì¡°ìœ¨</h4>
        <div>
            <a id="loginBtn" href="#" class="btn btn-warning btn-sm me-2">ğŸ”” êµ¬ê¸€ ë¡œê·¸ì¸/ì°¸ì—¬</a>
            <button class="btn btn-outline-primary btn-sm" onclick="copyLink()">ğŸ”— ë§í¬ ë³µì‚¬</button>
        </div>
    </div>

    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body">
            <h6 class="card-title fw-bold text-primary">ğŸ‘¥ í˜„ì¬ ì°¸ì—¬ ì¤‘ì¸ ë©¤ë²„</h6>
            <div id="member-list" class="d-flex flex-wrap gap-2">
                <span class="text-muted small">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </div>
        </div>
    </div>

    <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-my-schedule" data-bs-toggle="pill" onclick="switchMode('edit')">
                âœï¸ ë‚´ ì¼ì • ìˆ˜ì • (ì œì™¸í•˜ê¸°)
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-result" data-bs-toggle="pill" onclick="switchMode('result')">
                âœ¨ ë¹ˆ ì‹œê°„ ê²°ê³¼ ë³´ê¸°
            </button>
        </li>
    </ul>

    <div id="result-controls" class="text-center mb-3" style="display: none;">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-success active" onclick="showResult('time')">ì‹œê°„ìœ¼ë¡œ ë³´ê¸°</button>
            <button type="button" class="btn btn-outline-success" onclick="showResult('date')">ë‚ ì§œë¡œë§Œ ë³´ê¸°</button>
        </div>
    </div>

    <div id='calendar' class="shadow-sm"></div>

    <div class="text-center mt-3">
        <p class="text-muted small">* 'ë‚´ ì¼ì • ìˆ˜ì •' íƒ­ì—ì„œ ì¼ì •ì„ í´ë¦­í•˜ë©´ ê³„ì‚°ì—ì„œ ì œì™¸(ë¬´ì‹œ)ë©ë‹ˆë‹¤.</p>
    </div>
</div>

<script>
    let calendar;
    let currentUuid = new URLSearchParams(window.location.search).get('uuid');
    let currentMode = 'edit';

    document.addEventListener('DOMContentLoaded', function() {
        if (!currentUuid) { alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤."); return; }

        // ë¡œê·¸ì¸ ë²„íŠ¼ ë§í¬ ì„¤ì •
        const loginBtn = document.getElementById('loginBtn');
        if(loginBtn) {
            loginBtn.href = `/login/google?uuid=${currentUuid}`;
        }

        const calendarEl = document.getElementById('calendar');

        // ìº˜ë¦°ë” ì´ˆê¸°í™”
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            locale: 'ko',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'timeGridWeek,dayGridMonth'
            },
            height: 'auto',
            allDaySlot: true,
            // ì´ë²¤íŠ¸ í´ë¦­ ì‹œ (í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ ë™ì‘)
            eventClick: function(info) {
                if (currentMode === 'edit') {
                    toggleIgnoreEvent(info.event);
                } else {
                    alert("ê²°ê³¼ í™”ë©´ì—ì„œëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            }
        });

        calendar.render();

        // ì²˜ìŒì—” ë‚´ ì¼ì • ë¡œë”©
        loadMyEvents();
        loadMembers();
    });

    // ----------------------------------------------------
    // [NEW] ë©¤ë²„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    // ----------------------------------------------------
    async function loadMembers() {
        try {
            const response = await fetch(`/api/rooms/${currentUuid}/members`);
            if (response.ok) {
                const members = await response.json();
                const listEl = document.getElementById('member-list');

                if (members.length === 0) {
                    listEl.innerHTML = '<span class="text-muted small">ì•„ì§ ì•„ë¬´ë„ ì•ˆ ì™”ì–´ìš”!</span>';
                    return;
                }

                // ë©¤ë²„ ì´ë¦„í‘œ(ë±ƒì§€) ë§Œë“¤ê¸°
                listEl.innerHTML = members.map(name =>
                    `<span class="badge bg-info text-dark border p-2">ğŸ˜Š ${name}</span>`
                ).join('');

                // (ì„ íƒì‚¬í•­) ëª‡ ëª…ì¸ì§€ ì œëª© ì˜†ì— í‘œì‹œí•´ë„ ì¢‹ìŒ
                // document.getElementById('roomTitle').innerText += ` (${members.length}ëª…)`;
            }
        } catch (e) {
            console.error("ë©¤ë²„ ë¡œë”© ì‹¤íŒ¨", e);
        }
    }

    // ----------------------------------------------------
    // 1. ëª¨ë“œ ì „í™˜ (íƒ­ í´ë¦­)
    // ----------------------------------------------------
    function switchMode(mode) {
        currentMode = mode;
        calendar.removeAllEvents(); // í™”ë©´ ì´ˆê¸°í™”

        // ë²„íŠ¼ UI ì œì–´
        if (mode === 'edit') {
            document.getElementById('result-controls').style.display = 'none';
            calendar.changeView('timeGridWeek');
            loadMyEvents();
        } else {
            document.getElementById('result-controls').style.display = 'block';
            showResult('time'); // ê¸°ë³¸ì€ ì‹œê°„ ë³´ê¸°
        }
    }

    // ----------------------------------------------------
    // 2. ë‚´ ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° (í¸ì§‘ ëª¨ë“œ)
    // ----------------------------------------------------
    async function loadMyEvents() {
        try {
            const response = await fetch(`/api/rooms/${currentUuid}/my-events`);
            if (response.ok) {
                const events = await response.json();
                console.log("ë‚´ ì¼ì • ë°ì´í„°:", events);

                const mappedEvents = events.map(e => ({
                    id: e.id,       // DTOì˜ id (êµ¬ê¸€ID)
                    title: e.title, // DTOì˜ title
                    start: e.start, // DTOì˜ start
                    end: e.end,     // DTOì˜ end
                    className: e.isIgnored ? 'ignored-event' : '',
                    color: e.isIgnored ? '#d6d8db' : '#3788d8'
                }));

                calendar.addEventSource(mappedEvents);
            }
        } catch (e) {
            console.error("ë‚´ ì¼ì • ë¡œë”© ì‹¤íŒ¨", e);
        }
    }

    // ----------------------------------------------------
    // 3. ì¼ì • ë¬´ì‹œ í† ê¸€ (í´ë¦­ ì´ë²¤íŠ¸)
    // ----------------------------------------------------
    async function toggleIgnoreEvent(eventObj) {
        if (!confirm(`'${eventObj.title}' ì¼ì •ì„ ê³„ì‚°ì—ì„œ ì œì™¸(ë˜ëŠ” ë³µêµ¬)í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            // ì£¼ì†Œ ëì— /toggle ì—†ìŒ (ë°±ì—”ë“œì™€ ì¼ì¹˜)
            const response = await fetch(`/api/rooms/${currentUuid}/events/${eventObj.id}`, {
                method: 'POST'
            });

            if (response.ok) {
                if (eventObj.classNames.includes('ignored-event')) {
                    // ë³µêµ¬ë¨
                    eventObj.setProp('classNames', []);
                    eventObj.setProp('color', '#3788d8');
                } else {
                    // ë¬´ì‹œë¨ (íšŒìƒ‰ ì²˜ë¦¬)
                    eventObj.setProp('classNames', ['ignored-event']);
                    eventObj.setProp('color', '#d6d8db');
                }
            } else {
                alert("ì²˜ë¦¬ ì‹¤íŒ¨!");
            }
        } catch (e) {
            console.error(e);
        }
    }

    // ----------------------------------------------------
    // 4. ê²°ê³¼ ë³´ê¸° (ì‹œê°„ vs ë‚ ì§œ)
    // ----------------------------------------------------
    async function showResult(type) {
        calendar.removeAllEvents();

        // ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ ì²˜ë¦¬
        const btns = document.querySelectorAll('#result-controls button');
        btns.forEach(b => b.classList.remove('active'));
        if(window.event && window.event.target.tagName === 'BUTTON') {
            window.event.target.classList.add('active');
        }

        if (type === 'time') {
            calendar.changeView('timeGridWeek');

            try {
                // ì‹œê°„ API í˜¸ì¶œ
                const res = await fetch(`/api/rooms/${currentUuid}/available-times`);
                const slots = await res.json();
                console.log("ë¹ˆ ì‹œê°„ ë°ì´í„°:", slots);

                if(slots.length === 0) {
                    alert("ê°€ëŠ¥í•œ ì‹œê°„ì´ í•˜ë‚˜ë„ ì—†ìŠµë‹ˆë‹¤! ğŸ˜­");
                }



                const events = slots.map(s => ({
                    title: 'ê°€ëŠ¥!',
                    start: s.start,
                    end: s.end,
                    display: 'block',
                    className: 'free-time-highlight',
                    color: '#28a745'
                }));

                calendar.addEventSource(events);
            } catch(e) { console.error(e); }

        } else if (type === 'date') {
            calendar.changeView('dayGridMonth');

            try {
                // ë‚ ì§œ API í˜¸ì¶œ
                const res = await fetch(`/api/rooms/${currentUuid}/available-dates`);
                const dates = await res.json();
                console.log("ë¹ˆ ë‚ ì§œ ë°ì´í„°:", dates);

                const events = dates.map(d => ({
                    title: 'ì™„ì „ ë¹ˆ ë‚ !',
                    start: d,
                    display: 'background',
                    className: 'free-time-highlight',
                    color: '#28a745'
                }));
                calendar.addEventSource(events);
            } catch(e) { console.error(e); }
        }
    }

    function copyLink() {
        navigator.clipboard.writeText(window.location.href);
        alert("ë§í¬ ë³µì‚¬ ì™„ë£Œ!");
    }
</script>

</body>
</html>